name: GKE Autoscaling Load Test

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target URL (Frontend LoadBalancer IP or leave empty for auto-detect)'
        required: false
        type: string
      duration_seconds:
        description: 'Test duration in seconds'
        required: false
        default: '600'
        type: string
      workers:
        description: 'Number of worker processes'
        required: false
        default: '8'
        type: string
      concurrent_per_worker:
        description: 'Concurrent requests per worker'
        required: false
        default: '150'
        type: string

env:
  GCP_PROJECT_ID: cpe-autoscaling-k8s

jobs:
  load-test:
    name: Execute Load Test on GKE
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}
      
      - name: Install gke-gcloud-auth-plugin
        run: |
          gcloud components install gke-gcloud-auth-plugin --quiet
      
      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials cpe-autoscaling-gke \
            --zone=us-central1-a \
            --project=${{ env.GCP_PROJECT_ID }}
      
      - name: Get frontend URL (auto-detect)
        id: get-url
        run: |
          if [ -z "${{ github.event.inputs.target_url }}" ]; then
            echo "Auto-detecting frontend URL..."
            FRONTEND_IP=$(kubectl get svc frontend-service -n frontend -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
            echo "TARGET_URL=http://$FRONTEND_IP" >> $GITHUB_ENV
          else
            echo "TARGET_URL=${{ github.event.inputs.target_url }}" >> $GITHUB_ENV
          fi
          echo "Using target URL: $TARGET_URL"
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install aiohttp
      
      - name: Capture initial state
        run: |
          echo "## Initial Cluster State ðŸ“Š" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "Nodes:" >> $GITHUB_STEP_SUMMARY
          kubectl get nodes >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Backend Pods:" >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n backend >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "HPAs:" >> $GITHUB_STEP_SUMMARY
          kubectl get hpa -n backend >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
      
      - name: Health Check
        run: |
          echo "ðŸ¥ Checking target health..."
          curl -f "$TARGET_URL" || curl -f "$TARGET_URL/health" || echo "Warning: Health check returned non-200"
      
      - name: Run Load Test with ultra-load.py
        run: |
          echo "ðŸš€ Starting load test..."
          echo "Target: $TARGET_URL"
          echo "Workers: ${{ github.event.inputs.workers || '8' }}"
          echo "Concurrent per worker: ${{ github.event.inputs.concurrent_per_worker || '150' }}"
          echo "Duration: ${{ github.event.inputs.duration_seconds || '600' }}s"
          
          cd scripts
          python3 ultra-load.py "$TARGET_URL" \
            --workers ${{ github.event.inputs.workers || '8' }} \
            --concurrent ${{ github.event.inputs.concurrent_per_worker || '150' }} \
            --duration ${{ github.event.inputs.duration_seconds || '600' }} &
          
          LOAD_TEST_PID=$!
          
          # Monitorear cada 30 segundos durante la prueba
          DURATION=${{ github.event.inputs.duration_seconds || '600' }}
          CHECKS=$((DURATION / 30))
          
          for i in $(seq 1 $CHECKS); do
            echo "ðŸ“Š Status check $i/$CHECKS..."
            kubectl get hpa -n backend || true
            kubectl top pods -n backend || true
            kubectl get nodes || true
            sleep 30
          done
          
          # Esperar a que termine el test
          wait $LOAD_TEST_PID
      
      - name: Capture post-load state
        run: |
          echo "## Post-Load Cluster State ðŸ“ˆ" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "Nodes:" >> $GITHUB_STEP_SUMMARY
          kubectl get nodes >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Backend Pods:" >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n backend >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "HPAs:" >> $GITHUB_STEP_SUMMARY
          kubectl get hpa -n backend >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
      
      - name: Cooldown monitoring
        run: |
          echo "â„ï¸ Cooldown period - monitoring scale down for 10 minutes..."
          for i in {1..20}; do
            echo "Cooldown check $i/20"
            kubectl get hpa -n backend || true
            kubectl get pods -n backend || true
            sleep 30
          done
      
  verify-autoscaling:
    name: Verify Autoscaling Activity
    runs-on: ubuntu-latest
    needs: load-test
    if: always()
    
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Install GKE auth plugin
        run: |
          gcloud components install gke-gcloud-auth-plugin --quiet
      
      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials cpe-autoscaling-gke \
            --zone us-central1-a \
            --project ${{ env.GCP_PROJECT_ID }}
      
      - name: Collect final metrics
        run: |
          echo "## ðŸ” Autoscaling Verification Results" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Final Cluster State" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "=== NODES ===" >> $GITHUB_STEP_SUMMARY
          kubectl get nodes -o wide >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "=== BACKEND DEPLOYMENT ===" >> $GITHUB_STEP_SUMMARY
          kubectl get deployment -n backend >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "=== BACKEND PODS ===" >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n backend -o wide >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "=== HPA STATUS ===" >> $GITHUB_STEP_SUMMARY
          kubectl get hpa -n backend >> $GITHUB_STEP_SUMMARY
          kubectl describe hpa backend-hpa -n backend >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
      
      - name: Get scaling events
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Recent Scaling Events ðŸ“‹" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          kubectl get events -n backend --sort-by='.lastTimestamp' | grep -E "Scaled|Normal" | tail -20 >> $GITHUB_STEP_SUMMARY || echo "No scaling events found" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
      
      - name: Resource utilization
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Resource Utilization ðŸ“Š" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "=== NODE METRICS ===" >> $GITHUB_STEP_SUMMARY
          kubectl top nodes >> $GITHUB_STEP_SUMMARY || echo "Metrics not available" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "=== POD METRICS (Backend) ===" >> $GITHUB_STEP_SUMMARY
          kubectl top pods -n backend >> $GITHUB_STEP_SUMMARY || echo "Metrics not available" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
      
      - name: Summary
        run: |
          NODE_COUNT=$(kubectl get nodes --no-headers | wc -l)
          POD_COUNT=$(kubectl get pods -n backend --no-headers | wc -l)
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Summary âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- **Nodes in cluster**: $NODE_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend pods**: $POD_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- **Load test duration**: ${{ github.event.inputs.duration_seconds || '600' }}s" >> $GITHUB_STEP_SUMMARY
          echo "- **Workers**: ${{ github.event.inputs.workers || '8' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Concurrent per worker**: ${{ github.event.inputs.concurrent_per_worker || '150' }}" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note**: Check the detailed logs above to verify if:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Backend pods scaled up during load" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Cluster nodes scaled up if needed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… HPA metrics show increased CPU/Memory" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Scaling events were triggered" >> $GITHUB_STEP_SUMMARY
